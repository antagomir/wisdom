%% unilaiva-songbook_common.sty
%% ============================
%%
%% This file contains the imports, style settings and macro (re)definitions
%% common to all the different versions of Unilaiva songbook. Please include
%% this in the beginning of your main .tex file just after \documentclass like
%% this:
%%
%% \usepackage{tex/unilaiva-songbook_common}
%%

\ProvidesPackage{unilaiva-songbook_common}

% Ensure output PDF to be of version 1.5; this is required for some features
\pdfminorversion=5


% BEGIN PACKAGE IMPORTS
% =====================

\usepackage[finnish,english]{babel}\selectlanguage{english}
\usepackage[utf8x]{inputenc}
% Use 'microtype' package for better appearance (especially for non-song chapters):
%   activate={true,nocompatibility} - activate protrusion and expansion
%   final - enable microtype; use "draft" to disable
%   tracking=true, kerning=true - activate these techniques
%   spacing=false - no interword spacing for compatibility with ragged2e,
%                   \nonfrenchspacing etc.
%   factor=1100 - add 10% to the protrusion amount (default is 1000)
%   stretch=10, shrink=10 - reduce stretchability/shrinkability (default is 20/20)
%   Affected fonts are defined later with \DefineMicrotypeSetDefault
\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=false,factor=1100,stretch=10,shrink=10]{microtype}
% Font weight defaults for Noto are regular and bold; here they are made heavier.
% Do not use font scaling as it messes with line spacing in some cases.
\usepackage[medium,extrabold]{noto}
\usepackage[T1]{fontenc}
% hyperref is used for URL links and by 'songs' package for index links in PDF.
% Option ocgcolorlinks colors the links instead of setting a box around them. These colours
% are displayed only in digital PDF, not in printed document. To enable these colors in
% print too, change the option to 'colorlinks'. The actual colors are defined further below.
% ocgcolorlinks requires PDF version 1.5, which is automatically set for pdftex
\usepackage[bookmarks,unicode,ocgcolorlinks]{hyperref} % used by 'songs' package for index links in PDF
% NOTE: * In versions before 2018-5-10 we used inner=20mm,outer=10mm,tmargin=16mm,bmargin=10mm,
%         but now the Golden Ratio rules. Old versions (before fancyheader) also used
%         headsep=5mm,headheight=3.5mm, but the result is about the same now.
%       * For the "default" printer, minimum top margin is 16mm (to print the chapter name fully)
\usepackage[a5paper,inner=16.18mm,outer=10mm,tmargin=16.18mm,bmargin=10mm,headsep=5mm,headheight=4.28mm,nofoot]{geometry} % page size + margins
\usepackage{graphicx} % for importing images
\usepackage{pdfpages} % for cover page
\usepackage{array} % used at least in Technical Information chapter
\usepackage{color} % for using colors in various elements
% Disable all warnings issued by latex starting with "You have requested package..." to allow
% warningless loading of packages from subdirectories without setting environment variables
% (can be omitted, but warnings will appear):
\usepackage{silence}\WarningFilter{latex}{You have requested package}
\usepackage{ragged2e} % used to force text justification in 'explanation' env
\usepackage{enumitem} % used to modify 'description' env within 'explanation' env
\usepackage{xstring} % used for string manipulation in \newsongkey{tags}
\usepackage{fancyhdr} % for customizing headers

% The most important 'songs' package, use the version in the project tree:
\usepackage[chorded]{ext_packages/songs/songs}

% END PACKAGE IMPORTS


% *****************************************************************************


% BEGIN STYLE & OTHER SETTINGS
% ============================

% Set book titles if they're not yet defined (one should define them in the main doc):
\providecommand\mainbooktitle{Unilaiva songbook} % the main title
% Full title, containing possible part information:
\providecommand{\thisbooktitle}{\mainbooktitle} %

% microtype: enable all microtype features (except tracking) for more fonts than in
% the defaults:
\DeclareMicrotypeSet{mosttext}{encoding={OT1,T1,T2A,LY1,OT4,QX,T5,TS1,EU1,EU2,TU},
                               size={scriptsize-Large}}
\DeclareMicrotypeSetDefault[protrusion,kerning,spacing,expansion]{mosttext}

\renewcommand{\familydefault}{\sfdefault} % Sets sans-serif as the default font family everywhere

% Allow further emergency stretching to fix some "overfull hbox" situations.
% See: https://www.tex.ac.uk/FAQ-overfull.html
\setlength{\emergencystretch}{3em}

\graphicspath{ {./content/img/} } % graphicx: set path to find images from

\definecolor{chordcolor}{rgb}{0.3,0,0.4} % color: use this for chords
\definecolor{mbarcolor}{rgb}{0.6,0.45,0.8} % color: use this for measure bar, was lighter: {0.8,0.7,0.9}
\definecolor{melodynotecolor}{rgb}{0.0,0.32,0.38} % color: use this for the encircled melody notes
\definecolor{verylightgray}{rgb}{0.92,0.92,0.92} % color: use this for song number bg & textnote bg (lighter gray)
\definecolor{internallinkcolor}{rgb}{0 0 0.4} % color: color used for internal links (non-print PDF only)
\definecolor{urllinkcolor}{rgb}{0.4 0 0.4} % color: color used for external links (non-print PDF only)
\definecolor{linkboxcolor}{rgb}{0.5,0.9,0.6} % color: color used for boxed links (non-print PDF only)

% hyperref: setup
\hypersetup{linkbordercolor=linkboxcolor,linkcolor=internallinkcolor,urlcolor=urllinkcolor,unicode=true,pdftitle=\thisbooktitle}

\renewcommand{\snumbgcolor}{verylightgray} % songs: song number (in prelude) background color
\renewcommand{\notebgcolor}{verylightgray} % songs: \musicnote and \textnote background color
\renewcommand{\idxbgcolor}{verylightgray} % songs: index alphabet sectino background color

\songcolumns{1} % songs: number of columns per page in songs environment
\songpos{3} % songs: song same column-page-doublepage positioning aggressiveness 0-3
\newcommand{\defaultlyricfont}{\sffamily\large} % set the lyrics font style (used below)
\renewcommand{\lyricfont}{\defaultlyricfont} % songs: modify lyrics font style
% songs: modify chord font style (add color and make smaller):
\renewcommand{\printchord}[1]{\sffamily\bfseries\small\color{chordcolor}#1}
% songs: modify meter class font style (add color):
\renewcommand{\meterfont}{\color{chordcolor}\scriptsize\sffamily\upshape}
\renewcommand{\notefont}{\normalsize} % songs: modify \textnote and \musicnote font (make smaller)
\renewcommand{\idxtitlefont}{\sffamily} % songs: font used for titles in indices
\renewcommand{\idxlyricfont}{\sffamily\slshape} % songs: font for alternate (lyric) titles in indices
\renewcommand{\idxscripfont}{\sffamily\small\slshape} % songs: font used for tag (scripture) index
% songs: use same text color for music notes as for chords:
\renewcommand\musicnote[1]{\ifchorded\textnote{\color{chordcolor}#1}\fi}%
% songs: use real flat symbol instead of # for typesetting:
\renewcommand{\sharpsymbol}{\ensuremath{^\sharp}}%
% songs: change distance of chords to lyrics
\renewcommand{\clineparams}{%
  \baselineskip=10.6pt%
  \lineskiplimit=1pt%
  \lineskip=1pt%
}
% songs: set width of the vertical repetition line used in choruses etc (default: 1pt):
\setlength{\cbarwidth}{1.2pt}
% songs: make capo note smaller
\renewcommand\capo[1]{%
  \iftranscapos\transpose{#1}\else\musicnote{{\scriptsize capo #1}}\fi%
}
% songs: reduces line spacing in non-chorded lyrics by the amount the chords would take space
%        without needing to set \chordsoff; also removes measure bar lines. Commented out for
%        now:
% \setlength\baselineadj{-\baselineskip}

%\addto\captionsfinnish{\renewcommand\chaptername{}} % sets chapter name prefix to nothing when babel: finnish
\addto\captionsenglish{\renewcommand\chaptername{}} % sets chapter name prefix to nothing when babel: english
\addto\captionsenglish{\renewcommand\appendixname{}} % sets appendix name prefix to nothing when babel: english

% BEGIN Setup headers using fancyhdr (similar to default "book" style)
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\rmfamily\small\thepage} % page nr
\fancyhead[LO]{\rmfamily\small\itshape{\rightmark}} % odd left: section name
\fancyhead[RE]{\rmfamily\small\itshape{\leftmark}} % even right: chapter name
\fancyhead[CE]{\rmfamily\small\itshape{\thisbooktitle}} % even center: book name
\renewcommand{\headrulewidth}{0pt}
% END setup headers using fancyhdr

% Comment the following line out if you don't want extra info shown in song preludes.
% Define it for a song by adding ex= parameter to \beginsong
% It can be used to for example indicate the origins or a language of a song.
\newcommand{\showextrainfo}{} % comment this line out if you don't want extra info shown (ex=?)

% Comment the following line out if you don't want phase info shown in song preludes.
% Define it for a song by adding ph= parameter to \beginsong
\newcommand{\showphaselist}{} % comment this line out if you don't want phase info shown (ph=?)
\newcommand{\showphaselistintoc}{} % comment this line out if you don't want phase info shown in TOC

% Comment the following line out if you don't want tag lists shown in song preludes
% Define a list of tags for a song by adding tags= parameter to \beginsong
% It is supposed to be a short list of single word tags of which an index is created.
\newcommand{\showtaglist}{} % comment this line out if you don't want tag list shown (tags=?)

\newcommand{\showmelodynotes}{} % comment this line out if you don't want the encircled melody notes

% Comment the following line out if you don't want verse numbers shown. Choruses and verses are
% aligned only when verse numbers are not shown.
%\newcommand{\showversenumbers}{} % Suggestion: keep this one commented out!


% END STYLE & OTHER SETTINGS


% *****************************************************************************


% BEGIN WORKAROUNDS
% =================

% This is to work around a problem that only appears in the Samskrtam chapter's page headers
% strangely in the main non-two-booklet version only:
% "[PLEASEINSERT\PRERENDERUNICODE{}INTOPREAMBLE]"
\PrerenderUnicode{ṃ}%\PrerenderUnicode{Ṃ}
\PrerenderUnicode{ṛ}%\PrerenderUnicode{Ṛ}


% END WORKAROUNDS


% *****************************************************************************


% BEGIN DEFINITIONS AND REWRITES
% ==============================

% This command creates the second page at where it is called. This is supposed
% to be the odd verso page right after the cover.
% Parameters: 1) subtitle, 2) subsubtitle. Parameters can be left empty.
\newcommand{\secondpage}[2]{
  { % must be contained within a block for the settings to not bleed
    \thispagestyle{empty}
    \topskip0pt
    \vspace*{5.05em} % align with "Contents" heading on the next page; BAD for any changes
    \begin{center}
      \Huge \mainbooktitle\\
      \normalsize\textit{paths to higher knowledge}\\
      \ifx&#1&% #1 is empty
      \else % #1 not empty
        \vspace{1em}
        \Large \textbf{#1}\\
        \ifx&#2&% #2 is empty
        \else % #2 not empty
          \vspace{0.3em}%
          \normalsize #2\\
        \fi
      \fi
      \vspace*{\fill}
      \large By:\\
      \Large \textbf{humankind}\\
      \vspace{1em}
      \large Version:\\
      \Large \the\year-\ifnum\month<10 0\fi\the\month-\ifnum\day<10 0\fi\the\day\hspace{0.34em}$\beta$
      \\
      \vspace*{\fill}
      % Created with: qrencode -s 16 -l M -o content/img/QR_https_unilaiva_aavalla_net.png "https://unilaiva.aavalla.net/"
      \includegraphics[width=0.25\textwidth]{QR_https_unilaiva_aavalla_net.png}
      \\
      {\small\url{https://unilaiva.aavalla.net/}}
      \\
      \vspace*{\fill}
      {\footnotesize Compiled by: antagomir \& larva (\href{mailto:lari.natri@iki.fi}{lari.natri@iki.fi})}
      \\
      \vspace{1.5em}
      {\scriptsize
        The material in this book is collected from various sources over time.\\
        \vspace{-1em} % workaround for too large line spacing
        This is a work in progress, and made for the contributors' private use.
        \vspace{-1em} % workaround for too large line spacing
      }
    \end{center}
  }
}

% This is used for the main chapters of the book. Indices, instead, use \songchapter (internally).
% Required parameter is the chapter name, and optional is a filename for an image. So use it like:
% \mainchapter{Chapter Name} or \mainchapter[image.png]{Chapter Name}
\newcommand{\mainchapter}[2][]{%
  \chapter{#2}
  \thispagestyle{empty} % to omit the page number in the bottom
  \ifx&#1&% parameter #1 is empty (the optional one, given inside [])
  \else % parameter #1 is not empty, display image
    \begin{center}%
      \vspace*{\fill}%
      % 0.618 (Golden Ratio)
      \includegraphics[width=0.618\textwidth]{#1}%
      \vspace*{\fill}%
    \end{center}%
  \fi
  \clearpage
}

% This command will display some text followed by three dots,
% and aligned to the right of the page. The idea is to use it as a signal to go to
% a different part of the song, for example the chorus. You can use it within the
% last verse or between verses (in such a case it will be put on its own line).
\newcommand{\gotochorus}[1]{\hfill {\normalsize\textit{\bfseries{→ #1\ldots}}}\par}

% This command will make a small horizontal space. Use this for example in the
% beginning of chorus lines, if you wish the chorus to stand out visually.
\newcommand{\chorusindent}{\hspace{1em}}

% "Glues" consecutive verses together: lessens the vertical space between them.
% This is to be used between verses/choruses. Note that it doesn't actually glue
% anything: page or column brake might be put between verses with this. Must be
% in sync with \versesep below.
\newcommand{\glueverses}{\vspace{-14pt}}

% songs: Verse separation +/-; must be in sync with \glueverses (that's why it is
% here). +/- 0 would be best, but in some cases a song can be fitted on a page with
% smaller separation only. Hopefully \glueverses is not used in those places.
\versesep=14pt plus 0pt minus 3pt%

% Displays the parameter text centered in a large font. Use within songs, but outside
% verses. Intended to be used for short mantras for recitation.
\newcommand{\showmantra}[1]{{\vspace{1.5em}\begin{center}\Large #1\end{center}}\vspace{1.0em}}

% environment for 'song feeler'
\newenvironment{feeler}{
  \vspace{2em}
  \small
  \par\noindent\ignorespaces
  \begin{center}\begin{em}
}{
  \end{em}\end{center}
  %\par\noindent\ignorespacesafterend
}

% environment for 'song explanation'
\newenvironment{explanation}{
  \setlist[description]{% modify description list (enumitem package)
    %topsep=30pt,%      % space before start / after end of list
    %itemsep=5pt,%      % space between items
    font={\rmfamily}%   % set the label font
  }
  \justifying % ragged2e package: force justifying
  \vspace{2em}%
  \rmfamily\footnotesize%
  \par\noindent\ignorespaces%
}{
  \par\noindent\ignorespacesafterend
}

% environment for song translation, to be used inside a song
\newenvironment{translation}{
  \newcommand{\nextverse}{\vspace{.5em}} % some vertical space between verses
  \beginverse*
  \chordsoff%
  \vspace{1em}%
  \small%
}{
  \endverse
}

% Just prints a dash if measure bar lines are enabled and does nothing otherwise.
% Use this if a line would end at a new measure starting without any lyrics in that
% bar on the same line. This signifies that there indeed is a measure here. them
% measure might or might not continue on the next line. You can think of this as
% an abbreviation for "Empty" or "End". :)
\newcommand{\e}{\ifmeasures--\fi}


% BEGIN MELODY NOTES

% MELODY NOTES feature
%
% These \note<something> commands display an encircled note name hint. They
% are meant to display (sung) melody notes above the lyrics. The commands
% must be called from within a chord definition. For example: \[\note{A}]
% The note must be written as upper case for transposing to work, even though
% the result is actually presented in lower case.
%
% To enable displaying of the notes, define \newcommand{\showmelodynotes}{}
% in the main document. To not display them, comment it out.
% Also, \color{melodynotecolor} must be defined.
%
% Call \notesoff command between verses to disable showing of notes in the
% following verses of the song.Unilaiva songbook
%
% The recommended use for this feature is to display the first sung non-unison
% melody interval of each song. So just specify the first two melody notes and
% use \notesoff after the first verse.
%
% If in doubt of which of these macros to use, use the \note macro.

% Displays encircled note name;
%   Parameter 1: the note name
%   Parameter 2: X coordinate offset (can be negative)
%   Parameter 3: Y coordinate offset (can be negative)
\newcommand{\noteDELTAXY}[3]{%
  \ifdefined\showmelodynotes%
    \ifdefined\melodynotesdisabled%
    \else%
      % Use the real sharp symbol instead of #, because it fits better within a circle:
      \renewcommand{\sharpsymbol}{\ensuremath{^\sharp}}%
      \notenamesout abcdefg%
      \hspace{#2}\raisebox{#3}{\textmd{\color{melodynotecolor}\footnotesize\textcircled{\tiny\transposehere{#1}}}}%
    \fi%
  \fi%
}
% Displays encircled note name (parameter 1). This is the default and can be used
% anywhere. USE THIS ONE if uncertain!
\newcommand{\note}[1]{%
  \noteDELTAXY{#1}{0em}{0.4em}%
}
% Displays encircled note name (parameter 1). The circle is moved up.
% This version is meant to be used ONLY ON THE FIRST LINE OF A VERSE.
% Use this when there is no chord in the same chord block.
\newcommand{\noteU}[1]{%
  \noteDELTAXY{#1}{0em}{1.00em}%
}
% Displays encircled note name (parameter 1). The circle is moved up and left.
% This version is meant to be used ONLY ON THE FIRST LINE OF A VERSE.
% Use this when there is a one letter chord name on the same chord block,
% a major triad.
\newcommand{\noteUL}[1]{%
  \noteDELTAXY{#1}{-0.6em}{1.00em}%
}
% Displays encircled note name (parameter 1). The circle is moved up and left.
% This version is meant to be used ONLY ON THE FIRST LINE OF A VERSE.
% Use this when there is a longer than one letter chord name on the same
% chord block.
\newcommand{\noteULL}[1]{%
  \noteDELTAXY{#1}{-1.56em}{1.00em}%
}
% Displays encircled note name (parameter 1). The circle is moved up.
% This version is meant to be used ONLY ON THE FIRST LINE OF A VERSE,
% with custom X coordinate offset (parameter 2, can be negative).
\newcommand{\noteUDELTAX}[2]{%
  \noteDELTAXY{#1}{#2}{1.00em}%
}

% Displays encircled note name (parameter 1). The circle is moved up.
% This version is meant to be used ONLY ON THE FIRST LINE OF A VERSE,
% with custom X coordinate offset (parameter 2, can be negative). Space
% is added after the note to ensure that the next chord will be
% displayed at the correct X coordinate. Note that this is not to be
% used when two or more notes are displayed within the same chord.
\newcommand{\noteUDELTAXspace}[2]{%
  \noteUDELTAX{#1}{#2}\hspace{-#2}%
}

% \noteson and \notesoff commands can be used between verses to turn displaying the
% melody notes on or off for the remaining of the current song or until another call
% to either of the macros. The notes are never displayed, if \showmelodynotes is not
% defined (in the main document).
\newcommand{\notesoff}{\def\melodynotesdisabled{}}
\newcommand{\noteson}{\let\melodynotesdisabled\undefined}

% END MELODY NOTES

% BEGIN PRELUDE

% Support for extra song information. To show these in song preludes,
% define \newcommand{\showextrainfo}{} in the main document.
% To define this for a song, use ex={} parameter for \beginsong
\newcommand{\extrainfo}{}
\newsongkey{ex}{\def\extrainfo{}}
               {\def\extrainfo{#1\par}}

% Support for phase hints for songs. To show these in song preludes,
% define \newcommand{\showphaselist}{} in the main document.
% To define this for a song, use ph={} parameter for \beginsong
\newcommand{\phaselist}{}%
\newsongkey{ph}{\def\phaselist{}}
               {\def\phaselist{#1}}

% BEGIN PRELUDE/TAGS

% Support for tags for songs. To show them in song preludes,
% define \newcommand{\showtaglist}{} in the main document.
% Tags are defined as tags= keyval for \beginsong. An example:
% \beginsong{Songname}[tags={fire 1, water 1}. Note the weird
% syntax: the tagname must be followed by ' 1'. Valid tags are
% defined in file 'tags.can'.

\newcommand{\taglist}{}% defined below for each song

\makeatletter%

\newsongkey{tags}{\def\taglist{}\def\SB@rawrefs{}\gdef\songrefs{}}%
                 {\def\taglist{\StrSubstitute{#1}{ 1}{}\par}% xstring: Show only tag name, remove ' 1'
                  \def\SB@rawrefs{#1}\SB@parsesrefs{#1}}

\renewcommand\SB@makescripindex{%
  \renewenvironment{SB@lgidx}[1]{%
    \gdef\SB@idxcolhead{##1}%
    % Following three lines are commented out to skip the line used for book name
    %\hbox to\hsize{{\idxbook{##1}}\hfil}%
    %\nobreak%
    %\SB@idxheadsep\nointerlineskip%
  }{%
    \mark{\noexpand\relax}%
    \penalty-20\vskip3\p@\@plus3\p@\relax%
  }%
  \renewenvironment{SB@smidx}[1]
    {\begin{SB@lgidx}{##1}}{\end{SB@lgidx}}%
  \renewcommand\idxentry[2]{%
    \SB@ellipspread{\idxscripfont\relax\SB@idxcolhead}% ##1 -> SB@idxcolhead to display 'book name' instead of 'chapter number'
                   {{\idxrefsfont\relax##2}}%
    \SB@toks\expandafter{\SB@idxcolhead}%
    \mark{\noexpand\SB@idxcont{\the\SB@toks}}%
  }%
  \renewcommand\idxaltentry[2]{\SB@erridx{a scripture}}%
  \SB@displayindex%
}

\makeatother%

% END PRELUDE/TAGS


% Redefine displaying of song prelude extension. This version adds
% some of the new song keyvals introduced above. \showrefs is removed,
% because we use the scripture references as tags and they are displayed
% with \taglist.
\makeatletter%
\renewcommand{\extendprelude}{%
  \ifdefined\showtaglist%   following is similar to \showauthors
    {\setbox\SB@box\hbox{\hfill\textit{\taglist}}%
     \ifdim\wd\SB@box>\z@\unhbox\SB@box\par\vspace{-1em}\fi% Go up one line if tag list was non-empty
    }%
  \fi%
  \showauthors%
  \ifdefined\showextrainfo%
    {\extrainfo}%
  \fi%
}
\makeatother

% Redefine the song prelude display. Only one line is modified (see comment)
% to show the phase list on the same line with the main title.
\makeatletter
\renewcommand\makeprelude{
  \resettitles%
  \ifslides%
    \hbox to\hsize{{\hfil\stitlefont\relax\songtitle\hfil}}%
    \vskip5\p@%
    \hbox to\hsize{%
      \hfil%
      \vbox{%
        \divide\hsize\tw@\parskip\p@\relax%
        \centering\small\extendprelude%
      }%
      \hfil%
    }%
  \else%
    \ifdim\songnumwidth>\z@%
      \setbox\SB@boxii\hbox{{\SB@colorbox\snumbgcolor{%
        \hbox to\songnumwidth{%
          \printsongnum{\thesongnum}\hfil%
        }%
      }}}%
    \fi%
    \setbox\SB@box\vbox{%
      \ifdim\songnumwidth>\z@%
        \SB@dimen\wd\SB@boxii%
        \advance\SB@dimen3\p@%
        \ifpagepreludes\multiply\SB@dimen\tw@\fi%
        \advance\hsize-\SB@dimen%
      \fi%
      \ifpagepreludes\centering\else\SB@raggedright\fi%
      \offinterlineskip\lineskip\p@%
      {\stitlefont\relax%
       % The following line is modified (everything between \songtitle and \par is added:
       \songtitle{%
         \ifdefined\showphaselist{\normalfont\rmfamily\tiny\hfill\raisebox{1em}{\phaselist}}\\\fi%
       }\par%
       \nexttitle%
       \foreachtitle{(\songtitle)\par}}%
      \ifdim\prevdepth=\z@\kern\p@\fi%
      \parskip\p@\relax\tiny%
      \extendprelude%
      \kern\z@%
    }%
    \ifdim\songnumwidth>\z@%
      \hbox{%
        \ifdim\ht\SB@boxii>\ht\SB@box%
          \box\SB@boxii%
          \kern3\p@%
          \vtop{\box\SB@box}%
        \else%
          \SB@colorbox\snumbgcolor{\vbox to\ht\SB@box{{%
            \hbox to\songnumwidth{%
              \printsongnum{\thesongnum}\hfil%
            }\vfil%
          }}}%
          \kern3\p@%
          \box\SB@box%
        \fi%
      }%
    \else%
      \unvbox\SB@box%
    \fi%
  \fi%
}
\makeatother

% END PRELUDE

% The following rewrite of the \SB@@@beginsong command adds songs to the basic TOC also.
% Changes: lines between and including the first and last '\hypersetup' commands were added.
\makeatletter
\renewcommand\SB@@@beginsong{%
  \global\SB@stanzafalse%
  \setbox\SB@chorusbox\box\voidb@x%
  \SB@gotchorusfalse%
  \setbox\SB@songbox\vbox\bgroup\begingroup%
    \ifnum\SB@numcols>\z@\hsize\SB@colwidth\fi%
    \leftskip\z@skip\rightskip\z@skip%
    \parfillskip\@flushglue\parskip\z@skip%
    \SB@raggedright%
    \global\SB@transposefactor\z@%
    \global\SB@cr@{\\}%
    \protected@edef\@currentlabel{\p@songnum\thesongnum}%
    \setcounter{versenum}{1}%
    \SB@prevversetrue%
    \meter44%
    \resettitles%
    \SB@addtoindexes\songtitle\SB@rawrefs\songauthors%
    \nexttitle%
    \foreachtitle{\expandafter\SB@addtotitles\expandafter{\songtitle}}%
    \resettitles%
    \lyricfont\relax%
    \SB@setbaselineskip%
    \hypersetup{bookmarksdepth=0}% the first added line
    \phantomsection%
    \addcontentsline{toc}{subsection}{%
      \numberline{\thesongnum}%
      \songtitle\relax%
      \ifdefined\showphaselistintoc{%
        \hspace{0.15em}\scriptsize\textsuperscript{\rmfamily\tiny\phaselist}}\fi%
      }%
    \hypersetup{bookmarksdepth=2}% the last added line
}

% The following rewrite adds only \color{mbarcolor} command to change the color of the measure bar
\renewcommand\SB@makembar[2]{%
  \ifSB@inverse\else%
    \ifSB@inchorus\else\SB@errmbar\fi%
  \fi%
  \ifhmode%
    \SB@skip\lastskip\unskip%
    \setbox\SB@box\lastbox%
    \copy\SB@box%
    \ifvbox\SB@box%
      \begingroup%
        \setbox\SB@boxii\copy\SB@box%
        \vbadness\@M\vfuzz\maxdimen%
        \setbox\SB@boxii%
          \vsplit\SB@boxii to\maxdimen%
      \endgroup%
      \long\edef\SB@temp{\splitfirstmark}%
      \ifx\SB@temp\SB@measuremark%
        \penalty100\hskip1em%
      \else%
        \penalty100\hskip\SB@skip%
      \fi%
    \else%
      \penalty100\hskip\SB@skip%
    \fi%
  \fi%
  \ifvmode\leavevmode\fi%
  \setbox\SB@box\hbox{{\meterfont\relax#1}}%
  \setbox\SB@boxii\hbox{{\meterfont\relax#2}}%
  \SB@dimen\wd\ifdim\wd\SB@box>\wd\SB@boxii\SB@box\else\SB@boxii\fi%
  \SB@dimenii\baselineskip%
  \advance\SB@dimenii-2\p@%
  \advance\SB@dimenii-\ht\SB@box%
  \advance\SB@dimenii-\dp\SB@box%
  \advance\SB@dimenii-\ht\SB@boxii%
  \advance\SB@dimenii-\dp\SB@boxii%
  \let\SB@temp\relax%
  \ifdim\SB@dimen>\z@%
    \advance\SB@dimenii-.75\p@%
    \def\SB@temp{\kern.75\p@}%
  \fi%
  \SB@maxmin\SB@dimen<{.5\p@}%
  \SB@maxmin\SB@dimenii<\z@%
  \vbox{%
    \mark{\SB@measuremark}%
    \hbox to\SB@dimen{%
      \hfil%
      \box\SB@box%
      \hfil%
    }%
    \nointerlineskip%
    \hbox to\SB@dimen{%
      \hfil%
      \box\SB@boxii%
      \hfil%
    }%
    \SB@temp%
    \nointerlineskip%
    \hbox to\SB@dimen{%
      \hfil%
      \color{mbarcolor}\vrule\@width.5\p@\@height\SB@dimenii%
      \hfil%
    }%
  }%
  \meter{}{}%
}
\let\SB@mbar\SB@makembar

% Align choruses and verses if verse numbers are not shown. To show verse
% numbers instead, define \newcommand{\showversenumbers}{} in the main
% document.
\ifdefined\showversenumbers%
\else%
  \noversenumbers%
  \renewcommand\beginverse{%
    \begingroup%
      \SB@loadactives%
      \@ifstar{\endgroup\vnumberedfalse\SB@beginverse}% % keep this to consume the star
              {\endgroup\vnumberedfalse\SB@beginverse}% % this line was changed
  }
  \renewcommand\SB@cbarshift{%
    \ifdim\cbarwidth>\z@% % removed '\ifSB@inchorus' to shift in verses too
      \advance\leftskip\cbarwidth%
      \advance\leftskip5\p@\relax%
    \fi%
  }
\fi%

% The following rewrite adds one line to make the vertical chorus bar a bit shorter, so
% that choruses can be used as repeats with \glueverses.
\renewcommand\SB@chorusbar[1]{%
  \ifdim\cbarwidth>\z@%
    \SB@dimen\ht#1%
    \SB@dimenii\dp#1%
    \advance\SB@dimen%
      \ifSB@chorustop\ifchorded\else2\fi\fi\SB@dimenii%
    \advance\SB@dimen-.8\SB@dimenii% % this line added to shorten the chorus bar
    \SB@skip\SB@dimen\relax%
    \SB@computess\SB@skip1\@plus#1%
    \SB@computess\SB@skip{-1}\@minus#1%
    \nointerlineskip\null\nobreak%
    \leaders\vrule\@width\cbarwidth\vskip\SB@skip%
    \ifSB@chorustop\ifchorded\else%
      \advance\SB@skip-\SB@dimenii%
    \fi\fi%
    \nobreak\vskip-\SB@skip%
  \fi%
}

\makeatother

% END DEFINITIONS AND REWRITES

% *****************************************************************************

